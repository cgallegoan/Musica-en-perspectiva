---
output:
  pdf_document: default
  html_document: default
---

Cargamos los datos:

```{r}

load("C:/Users/losaa/OneDrive/Escritorio/Estudios/Proyecto II/ncdata.RData")
load("C:/Users/losaa/OneDrive/Escritorio/Estudios/Proyecto II/desc_data2.RData")
load("C:/Users/losaa/OneDrive/Escritorio/Estudios/Proyecto II/final_data.RData")
```

```{r}
library(FactoMineR)
library(factoextra)
library(dbplyr)
library(knitr)
library(dplyr)
```
Elegimos las variables para el PCA
```{r}
variablesnc = desc_data$variable[desc_data$type == 'numerical']
variablesnc = variablesnc[-15] # QUitamos la columna classical
variablesnc = append(variablesnc, c('artists', 'id'))


hola = ncdata[ncdata$popularity > 70,]
hola2  =ncdata[ncdata$popularity <= 70 & ncdata$popularity > 60,]
hola3 = ncdata[ncdata$popularity <= 60 & ncdata$popularity > 50,]

datos = hola[,variablesnc]
datos2 = hola2[, variablesnc]
datos3 = hola3[, variablesnc]
```


Hacemos el PCA. Escalamos y centramos porque las unidades están en valores muy diferentes
```{r}
pca=PCA(datos,scale.unit = TRUE,graph=FALSE,ncp=10,quali.sup= c(13,14))
pca2 = PCA(datos2,scale.unit = TRUE,graph=FALSE,ncp=10,quali.sup= c(13,14))
pca3 = PCA(datos3,scale.unit = TRUE,graph=FALSE,ncp=10,quali.sup= c(13,14))
```

Determinamos el número de componentes principales que utilizaremos en nuestro modelo, par lo datos con popularidad mayor que 70:

```{r}
eig.val <- get_eigenvalue(pca)
kable(get_eigenvalue(pca))
VPmedio = 100 * (1/nrow(eig.val))

fviz_eig(pca, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red") # scree plot
```
Determinamos el número de componentes principales que utilizaremos en nuestro modelo, par lo datos con popularidad entre 60 y 70:

```{r}
eig.val2 <- get_eigenvalue(pca2)
kable(get_eigenvalue(pca2))


VPmedio = 100 * (1/nrow(eig.val2))

fviz_eig(pca2, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red") # scree plot
```
Determinamos el número de componentes principales que utilizaremos en nuestro modelo, par lo datos con popularidad entre 50 y 60:

```{r}
eig.val3 <- get_eigenvalue(pca3)
kable(get_eigenvalue(pca3))


VPmedio = 100 * (1/nrow(eig.val3))

fviz_eig(pca3, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red") # scree plot
```

Seleccionamos 4 dimensiones en los tres casos mencionados anteriormente. Primero haremos un estudio sobre las observaciones anómalas para los datos con popularidad mayor que 70:

```{r T2, fig.width=5, fig.height=5}
K = 4 
misScores = pca$ind$coord[,1:K]
miT2 = colSums(t(misScores**2) / eig.val[1:K])

I = nrow(datos2)
F95 = K*(I**2 - 1)/(I*(I - K)) * qf(0.95, K, I-K)
F99 = K*(I**2 - 1)/(I*(I - K)) * qf(0.99, K, I-K)

plot(1:length(miT2), miT2, type = "l", xlab = "Canciones", ylab = "T2")
abline(h = F95, col = "orange", lty = 2, lwd = 2)
abline(h = F99, col = "red3", lty = 2, lwd = 2)
anomalas = which(miT2 > F99)
anomalas = as.matrix(anomalas)
dim(anomalas)
noanomalas = which(miT2 < F99)
noanomalas = as.matrix(noanomalas)
dim(noanomalas)
```
Seguidamente utilizaremos los datos con popularidad entre 60 y 70:

```{r T2, fig.width=5, fig.height=5}
K = 4 
misScores2 = pca2$ind$coord[,1:K]
miT22 = colSums(t(misScores2**2) / eig.val2[1:K])

I = nrow(datos2)
F95 = K*(I**2 - 1)/(I*(I - K)) * qf(0.95, K, I-K)
F99 = K*(I**2 - 1)/(I*(I - K)) * qf(0.99, K, I-K)

plot(1:length(miT22), miT2, type = "l", xlab = "Canciones", ylab = "T2")
abline(h = F95, col = "orange", lty = 2, lwd = 2)
abline(h = F99, col = "red3", lty = 2, lwd = 2)
anomalas2 = which(miT22 > F99)
anomalas2 = as.matrix(anomalas2)
dim(anomalas2)
noanomalas2 = which(miT22 < F99)
noanomalas2 = as.matrix(noanomalas2)
dim(noanomalas2)
```
Por último, haremos el mismo procedimiento pero con datos de popularidad entre 50 y 60:

```{r}
K = 4 
misScores3 = pca3$ind$coord[,1:K]
miT23 = colSums(t(misScores3**2) / eig.val3[1:K])

I = nrow(datos3)
F95 = K*(I**2 - 1)/(I*(I - K)) * qf(0.95, K, I-K)
F99 = K*(I**2 - 1)/(I*(I - K)) * qf(0.99, K, I-K)

plot(1:length(miT23), miT2, type = "l", xlab = "Canciones", ylab = "T2")
abline(h = F95, col = "orange", lty = 2, lwd = 2)
abline(h = F99, col = "red3", lty = 2, lwd = 2)
anomalas3 = which(miT23 > F99)
anomalas3 = as.matrix(anomalas3)
dim(anomalas3)
noanomalas3 = which(miT23 < F99)
noanomalas3 = as.matrix(noanomalas3)
dim(noanomalas3)
```


Antes de decidir que haremos con estos datos anómalos queremos ver que resultado nos proporcionaría el modelo con estos datos incluidos. Posteriormente los quitaremos y veremos si las conclusiones cambian.

Interpretación para datos con popularidad mayor que 70:


```{r}
#Datos canciones de popularity > 70
fviz_pca_var(pca, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca, axes = c(3,4), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_contrib(pca, choice = "var", axes = 1)
fviz_contrib(pca, choice = "var", axes = 2)
fviz_contrib(pca, choice = "var", axes = 3)
fviz_contrib(pca, choice = "var", axes = 4)

```

Interpretación para datos con popularidad entre 60 y 70:

```{r}
#Datos canciones con popularity  50 < x < 70
fviz_pca_var(pca2, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca2, axes = c(1,4), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_contrib(pca2, choice = "var", axes = 1)
fviz_contrib(pca2, choice = "var", axes = 2)
fviz_contrib(pca2, choice = "var", axes = 3)
fviz_contrib(pca2, choice = "var", axes = 4)

```
Interpretación para datos con popularidad entre 50 y 60:

```{r}
fviz_pca_var(pca3, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca3, axes = c(1,4), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_contrib(pca3, choice = "var", axes = 1)
fviz_contrib(pca3, choice = "var", axes = 2)
fviz_contrib(pca3, choice = "var", axes = 3)
fviz_contrib(pca3, choice = "var", axes = 4)
```

Ahora reuniremos los tres casos, sólo para las dos primeras componentes principales, de manera que podamos comparar de un sólo vistazo.

```{r}
fviz_pca_var(pca3, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca2, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
```

Por último realizaremos un biplot para tener en cuenta la relación entre variables e individuos, si es el caso de que existiera relación.

```{r}
fviz_pca_biplot(pca3, axes = c(1,2), col.var = "contrib", label = "var", repel = TRUE, col.ind = datos3$popularity)
fviz_pca_biplot(pca2, axes = c(1,2), col.var = "contrib", label = "var", repel = TRUE, col.ind = datos2$popularity)
fviz_pca_biplot(pca, axes = c(1,2), col.var = "contrib", label = "var", repel = TRUE, col.ind = datos$popularity)
```
Recalculamos el modelo sin observaciones anómalas en los tres casos:

```{r}
hola = ncdata[ncdata$popularity > 70,]
hola2  =ncdata[ncdata$popularity <= 70 & ncdata$popularity > 60,]
hola3  =ncdata[ncdata$popularity <= 60 & ncdata$popularity > 50,]

datos = hola[noanomalas,variablesnc]
datos2 = hola2[noanomalas2, variablesnc]
datos3 = hola3[noanomalas3, variablesnc]
```

Recalculamos los tres modelos, sin observaciones extremas:

```{r}
pca=PCA(datos,scale.unit = TRUE,graph=FALSE,ncp=10,quali.sup= c(13,14))
pca2 = PCA(datos2,scale.unit = TRUE,graph=FALSE,ncp=10,quali.sup= c(13,14))
pca3 = PCA(datos3,scale.unit = TRUE,graph=FALSE,ncp=10,quali.sup= c(13,14))
```

Volvemos a decidir el número de componentes principales que queremos utilizar:

```{r}
eig.val <- get_eigenvalue(pca)
kable(get_eigenvalue(pca))
VPmedio = 100 * (1/nrow(eig.val))

fviz_eig(pca, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red") # scree plot
```

Con los datos con popularity entre 60 y 70:

```{r}
eig.val2 <- get_eigenvalue(pca2)
kable(get_eigenvalue(pca2))


VPmedio = 100 * (1/nrow(eig.val2))

fviz_eig(pca2, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red") # scree plot
```

Con los datos con popularity entre 50 y 60:

```{r}
eig.val3 <- get_eigenvalue(pca3)
kable(get_eigenvalue(pca3))
VPmedio = 100 * (1/nrow(eig.val3))

fviz_eig(pca3, addlabels = TRUE) +
  geom_hline(yintercept=VPmedio, linetype=2, color="red") # scree plot
```

Ahora veremos como ha cambiado en los tres casos el gráfico de T2-Hotelling. El primer caso con popularity mayor que 70:

```{r}
K = 4 
misScores = pca$ind$coord[,1:K]
miT2 = colSums(t(misScores**2) / eig.val[1:K])

I = nrow(datos)
F95 = K*(I**2 - 1)/(I*(I - K)) * qf(0.95, K, I-K)
F99 = K*(I**2 - 1)/(I*(I - K)) * qf(0.99, K, I-K)

plot(1:length(miT2), miT2, type = "l", xlab = "Canciones", ylab = "T2")
abline(h = F95, col = "orange", lty = 2, lwd = 2)
abline(h = F99, col = "red3", lty = 2, lwd = 2)
```

El segundo caso con popularity entre 60 y 70:

```{r}
misScores2 = pca2$ind$coord[,1:K]
miT22 = colSums(t(misScores2**2) / eig.val2[1:K])

I = nrow(datos2)
F95 = K*(I**2 - 1)/(I*(I - K)) * qf(0.95, K, I-K)
F99 = K*(I**2 - 1)/(I*(I - K)) * qf(0.99, K, I-K)

plot(1:length(miT22), miT22, type = "l", xlab = "Canciones", ylab = "T2")
abline(h = F95, col = "orange", lty = 2, lwd = 2)
abline(h = F99, col = "red3", lty = 2, lwd = 2)
```

El tercer caso con popularity entre 50 y 60:

```{r}
misScores3 = pca3$ind$coord[,1:K]
miT23 = colSums(t(misScores3**2) / eig.val3[1:K])

I = nrow(datos3)
F95 = K*(I**2 - 1)/(I*(I - K)) * qf(0.95, K, I-K)
F99 = K*(I**2 - 1)/(I*(I - K)) * qf(0.99, K, I-K)

plot(1:length(miT23), miT23, type = "l", xlab = "Canciones", ylab = "T2")
abline(h = F95, col = "orange", lty = 2, lwd = 2)
abline(h = F99, col = "red3", lty = 2, lwd = 2)
```

Realizaremos la interpretación de nuevo, pero esta vez sin observaciones extremas:

```{r}
fviz_pca_var(pca, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca, axes = c(3,4), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_contrib(pca, choice = "var", axes = 1)
fviz_contrib(pca, choice = "var", axes = 2)
fviz_contrib(pca, choice = "var", axes = 3)
fviz_contrib(pca, choice = "var", axes = 4)
```

Con los datos con popularity entre 60 y 70:

```{r}
fviz_pca_var(pca2, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca2, axes = c(1,4), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_contrib(pca2, choice = "var", axes = 1)
fviz_contrib(pca2, choice = "var", axes = 2)
fviz_contrib(pca2, choice = "var", axes = 3)
fviz_contrib(pca2, choice = "var", axes = 4)
```

Con los datos con popularity entre 50 y 60:

```{r}
fviz_pca_var(pca3, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca3, axes = c(1,4), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_contrib(pca3, choice = "var", axes = 1)
fviz_contrib(pca3, choice = "var", axes = 2)
fviz_contrib(pca3, choice = "var", axes = 3)
fviz_contrib(pca3, choice = "var", axes = 4)

```

A continuación, realizaremos los gráficos para las dos primeras dimensiones en los tres modelos que hemos creado:

```{r}
fviz_pca_var(pca3, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca2, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
fviz_pca_var(pca, axes = c(1,2), repel = TRUE, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
```

En último lugar, vamos a realizar una interpretación de la relación de las variables con las observaciones mediante un biplot e intenteramos sacar alguna conclusión de ello. Aunque como hemos visto en los biplots generados sin las observaciones anómalas, los score plots representando a los individuos se encontraban en una nube de puntos en el centro del biplot y poco podímas exraer de este gráfico. Veremos que ocurre para un biplot sin estas observaciones extremas:


```{r}
fviz_pca_biplot(pca3, axes = c(1,2), col.var = "contrib", label = "var", repel = TRUE, col.ind = datos2$popularity)
fviz_pca_biplot(pca2, axes = c(1,2), col.var = "contrib", label = "var", repel = TRUE, col.ind = datos2$popularity)
fviz_pca_biplot(pca, axes = c(1,2), col.var = "contrib", label = "var", repel = TRUE, col.ind = datos$popularity)
```